/* Copyright 1997 Acorn Computers Ltd
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
/* Title:   event.c
 * Purpose: event dispatching
 * Author:  IDJ
 * History: 19-Jun-94: IDJ: created
 *          01-Apr-97: KJB/ADH: added call to deregister all handlers for a given object ID
 *          10-Dec-97: EPW: added event_dispatch, so the app can call Wimp_Poll directly, then later dispatch the event
 *
 */

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "kernel.h"

#include "debug.h"

#include "types.h"

#include "event.h"

#include "wimpevent.h"
#include "tbevent.h"
#include "wimpmsg.h"


static IdBlock     *event__id_block = NULL;
static unsigned int event__mask     = Wimp_Poll_NullMask;

/* ------------------------------------- dispatching events ------------------------------------ */

static _kernel_oserror *dispatch (int event_code, WimpPollBlock *poll_block, IdBlock *id_block)
{
    if (event_code == 0x200)
        return tbevent_dispatch (poll_block, id_block);
    else if (event_code == Wimp_EUserMessage || event_code == Wimp_EUserMessageRecorded)
        return wimpmsg_dispatch (poll_block, id_block);
    else
        return wimpevent_dispatch (event_code, poll_block, id_block);
}


_kernel_oserror *event_dispatch (int event_code, WimpPollBlock *poll_block)
{
    /* Allow an app to dispatch an event after a wimp_poll manually.
     * This is mainly required by Java, but could be applicable to
     * other apps...
     */
    return dispatch(event_code, poll_block, event__id_block);
}


extern _kernel_oserror *event_poll (int *event_code, WimpPollBlock *poll_block, void *poll_word)
{
    /*
     * poll the wimp, and pass the event to the dispatcher
     */

    _kernel_swi_regs regs;
    _kernel_oserror *e;
    WimpPollBlock temp_block;

    if (!poll_block) poll_block = &temp_block;

    regs.r[0] = (int)event__mask;
    regs.r[1] = (int)poll_block;
    regs.r[3] = (int)poll_word;

    if ((e = _kernel_swi (Wimp_Poll, &regs, &regs)) != NULL)
        return e;

    if (event_code) *event_code = regs.r[0];

    e = dispatch (regs.r[0], poll_block, event__id_block);

    return e;
}


extern _kernel_oserror *event_poll_idle (int *event_code, WimpPollBlock *poll_block, unsigned int earliest, void *poll_word)
{
    /*
     * poll the wimp, and pass the event to the dispatcher
     */
    _kernel_swi_regs regs;
    _kernel_oserror *e;
    WimpPollBlock temp_block;

    if (!poll_block) poll_block = &temp_block;

    regs.r[0] = (int)event__mask;
    regs.r[1] = (int)poll_block;
    regs.r[2] = (int)earliest;
    regs.r[3] = (int)poll_word;

    if ((e = _kernel_swi (Wimp_PollIdle, &regs, &regs)) != NULL)
        return e;

    if (event_code) *event_code = regs.r[0];

    e = dispatch (regs.r[0], poll_block, event__id_block);

    return e;
}



/* ------------------------------------- registering/deregistering handlers ----------------------- */


/* wimp events */


_kernel_oserror *event_register_wimp_handler (int object_id, int event_code, WimpEventHandler handler, void *handle)
{
    return wimpevent_register_wimp_handler (object_id, event_code, handler, handle);
}

_kernel_oserror *event_deregister_wimp_handler (int object_id, int event_code, WimpEventHandler handler, void *handle)
{
    return wimpevent_deregister_wimp_handler (object_id, event_code, handler, handle);
}

_kernel_oserror *event_deregister_wimp_handlers_for_object (int object_id)
{
    return wimpevent_deregister_wimp_handlers_for_object(object_id);
}


/* toolbox events */

_kernel_oserror *event_register_toolbox_handler (int object_id, int event_code, ToolboxEventHandler handler, void *handle)
{
    return tbevent_register_toolbox_handler (object_id, event_code, handler, handle);
}


_kernel_oserror *event_deregister_toolbox_handler (int object_id, int event_code, ToolboxEventHandler handler, void *handle)
{
    return tbevent_deregister_toolbox_handler (object_id, event_code, handler, handle);
}

_kernel_oserror *event_deregister_toolbox_handlers_for_object (int object_id)
{
    return tbevent_deregister_toolbox_handlers_for_object(object_id);
}


/* wimp messages */

_kernel_oserror *event_register_message_handler (int msg_no, WimpMessageHandler handler, void *handle)
{
    return wimpmsg_register_message_handler (msg_no, handler, handle);
}


_kernel_oserror *event_deregister_message_handler (int msg_no, WimpMessageHandler handler, void *handle)
{
    return wimpmsg_deregister_message_handler (msg_no, handler, handle);
}



/* ------------------------------------- getting/setting poll mask -------------------------------- */

extern _kernel_oserror *event_set_mask (unsigned int mask)
{
    event__mask = mask;
    return NULL;
}

extern _kernel_oserror *event_get_mask (unsigned int *mask)
{
    if (mask != NULL)
        *mask = event__mask;
    return NULL;
}


/* ------------------------------------ initialisation/finalisation ----------------------------- */


extern _kernel_oserror *event_initialise (IdBlock *b)
{
    DEBUG debug_output ("event_initialise", "Initialising event system\n");

    if (b != NULL)
        event__id_block = b;

    return NULL;
}

extern _kernel_oserror *event_finalise (void)
{
    _kernel_oserror *e;

    e = wimpevent_finalise();
    if (e != NULL)
    {
        return e;
    }

    e = tbevent_finalise();
    if (e != NULL)
    {
        return e;
    }

    e = wimpmsg_finalise();
    if (e != NULL)
    {
        return e;
    }

    event__id_block = NULL;
    event__mask = Wimp_Poll_NullMask;

    return NULL;
}


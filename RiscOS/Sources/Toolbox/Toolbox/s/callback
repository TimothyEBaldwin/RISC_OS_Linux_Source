; Copyright 1996 Acorn Computers Ltd
;
; Licensed under the Apache License, Version 2.0 (the "License");
; you may not use this file except in compliance with the License.
; You may obtain a copy of the License at
;
;     http://www.apache.org/licenses/LICENSE-2.0
;
; Unless required by applicable law or agreed to in writing, software
; distributed under the License is distributed on an "AS IS" BASIS,
; WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
; See the License for the specific language governing permissions and
; limitations under the License.
;
; Title:   s.callback
; Purpose: To send a Service_ToolboxTaskBorn
; Author:  IDJ
; History: 26-Jul-94: IDJ: Created
;          24-Jan-95: IDJ: only send round toolbox_starting svc call, if
;                          NOT during ROM start-up.
;

r0      RN      0
r1      RN      1
r2      RN      2
r3      RN      3

r4      RN      4
r5      RN      5
r6      RN      6
r7      RN      7
r8      RN      8
r9      RN      9

r10     RN     10
r11     RN     11
r12     RN     12
r13     RN     13

sl      RN     10
fp      RN     11
ip      RN     12
sp      RN     13
lr      RN     14
pc      RN     15

XOS_ServiceCall  EQU  &20030

        EXPORT task_inform_callback_handler
        EXPORT toolbox_starting_callback_handler
	IMPORT task_inform_object_modules_callback

        AREA    |C$$Code|, CODE, READONLY

task_inform_callback_handler

	; Entry
	; R12 = private word of Toolbox module

	STMFD	r13!, {r0-r12, r14}
	MOV	r10, r13, lsr #20
	MOV	r10, r10, lsl #20	; Restore stack limit
	LDMIA	r10, {r4, r5}		; Read data from stack
	LDR	r12, [r12, #0]		; Get contents
	LDMIB	r12, {r11,r12}		; Read data relocation offsets
	STMIA	r10, {r11,r12}		; Store them
	ADD	r10, r10, #540		; Set up correct stack limit
	MOV	r11, #0			; Zero frame pointer
	BL	task_inform_object_modules_callback
	SUB	r10, r10, #540		; Find base of stack
	STMIA	r10, {r4, r5}		; Restore old values
	LDMFD	r13!, {r0-r12,pc}	; Reload registers and return


toolbox_starting_callback_handler

        ; Entry
        ; R12 = 0 => RAM start
        ; [R12] = 0 => RMReinit ROM Toolbox
        ; [R12] = 1 => ROM start-up of Toolbox

        STMFD   sp!,    {r0-r9, r10, r11, r12, lr}

        TEQ     r12,    #0                     ; are we in RAM?
        LDRNE   r1,     [r12]                  ; get value of ROM_started
        TEQNE   r1,     #0                     ; is it during ROM start-up?
        MOVNE   r1,     #0                     ; yes, then reset ROM_started
        STRNE   r1,     [r12]

        LDREQ   r1,     =&44ec1                ; Service_ToolboxStarting
        SWIEQ   XOS_ServiceCall

        LDMFD   sp!,    {r0-r9, r10, r11, r12, pc}

        END
